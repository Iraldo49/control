<!doctype html>
<html lang="pt-BR" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Conta do Bar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-yellow-50 font-sans">
  <div class="min-h-full flex"><!-- Sidebar -->
   <div class="bg-black text-yellow-400 w-64 min-h-screen fixed left-0 top-0 z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out" id="sidebar">
    <div class="p-6">
     <div class="mb-8">

      <div class="flex items-center">
                   <img class="w-20 h-20 rounded-full" src="img/2.png" alt="ícone de carrinho" />
                </div>
      <p id="welcome-message" class="text-yellow-300 text-sm mt-1">Bem-vindos ao nosso bar!</p>
     </div>
     <nav class="space-y-2"><button id="btn-nova-conta" class="w-full flex items-center px-4 py-3 text-left bg-yellow-500 text-black rounded-lg font-medium hover:bg-yellow-600 transition-colors">
       <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
       </svg> Nova Conta </button> <button id="btn-contas-ativas" class="w-full flex items-center px-4 py-3 text-left text-yellow-400 hover:bg-gray-800 rounded-lg font-medium transition-colors">
       <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
       </svg> Contas Ativas </button> <button id="btn-historico" class="w-full flex items-center px-4 py-3 text-left text-yellow-400 hover:bg-gray-800 rounded-lg font-medium transition-colors">
       <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
       </svg> Histórico </button>
     </nav>
    </div>
   </div><!-- Overlay para mobile -->
   <div class="fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden hidden" id="sidebar-overlay"></div><!-- Conteúdo Principal -->
   <div class="flex-1 lg:ml-64"><!-- Header Mobile -->
    <header class="bg-white shadow-sm lg:hidden">
     <div class="flex items-center justify-between px-4 py-3"><button id="menu-toggle" class="text-gray-600 hover:text-gray-900">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
       </svg></button>
        <div class="flex items-center">
    <img class="w-10 h-10 rounded-full" src="img/2.png" alt="ícone de carrinho" />
</div>

      <div class="w-6"></div>
     </div>
    </header>
    <main class="p-4 lg:p-8"><!-- Seção Nova Conta -->
     <div id="secao-nova-conta" class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-8">
      <h2 class="text-xl sm:text-2xl font-bold text-black mb-4 sm:mb-6">Abrir Nova Conta</h2>
      <form id="form-nova-conta" class="space-y-4">
       <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div><label for="cliente-nome" class="block text-sm font-medium text-gray-700 mb-2">Nome do Cliente</label> <input type="text" id="cliente-nome" required class="w-full px-3 py-3 sm:py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-base">
        </div>
        <div><label for="mesa-numero" class="block text-sm font-medium text-gray-700 mb-2">Mesa</label> <input type="text" id="mesa-numero" required class="w-full px-3 py-3 sm:py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-base">
        </div>
       </div><button type="submit" id="btn-abrir-conta" class="w-full bg-yellow-500 text-black py-3 px-4 rounded-md hover:bg-yellow-600 font-medium transition-colors text-base"> Abrir Conta </button>
      </form>
     </div><!-- Seção Contas Ativas -->
     <div id="secao-contas-ativas" class="hidden">
      <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-8">
       <h2 class="text-xl sm:text-2xl font-bold text-black mb-4 sm:mb-6">Contas Ativas</h2>
       <div id="lista-contas-ativas" class="space-y-4"><!-- Contas ativas serão inseridas aqui -->
       </div>
      </div>
     </div><!-- Seção Histórico -->
     <div id="secao-historico" class="hidden">
      <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
       <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 sm:mb-6 space-y-3 sm:space-y-0">
        <h2 class="text-xl sm:text-2xl font-bold text-black">Histórico de Contas</h2><button id="btn-limpar-historico" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors font-medium text-sm sm:text-base"> Limpar Histórico </button>
       </div>
       <div id="lista-historico" class="space-y-4"><!-- Histórico será inserido aqui -->
       </div>
      </div>
     </div><!-- Modal de Pedidos -->
     <div id="modal-pedidos" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
      <div class="flex items-center justify-center min-h-screen p-2 sm:p-4">
       <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[95vh] sm:max-h-[90vh] overflow-y-auto">
        <div class="p-4 sm:p-6">
         <div class="flex justify-between items-center mb-4 sm:mb-6">
          <h3 id="modal-titulo" class="text-lg sm:text-2xl font-bold text-black">Conta - Mesa</h3><button id="btn-fechar-modal" class="text-gray-400 hover:text-gray-600 text-2xl sm:text-3xl">×</button>
         </div><!-- Cardápio -->
         <div class="mb-6 sm:mb-8">
          <h4 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4">Cardápio</h4>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4" id="cardapio"><!-- Cardápio será inserido aqui -->
          </div>
         </div><!-- Pedidos da Conta -->
         <div class="mb-4 sm:mb-6">
          <h4 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4">Pedidos da Conta</h4>
          <div id="pedidos-conta" class="bg-gray-50 rounded-lg p-3 sm:p-4 min-h-[100px]"><!-- Pedidos serão inseridos aqui -->
          </div>
          <div class="mt-3 sm:mt-4 text-right"><span class="text-lg sm:text-xl font-bold text-black">Total: MT <span id="total-conta">0,00</span></span>
          </div>
         </div><!-- Botões de Ação -->
         <div class="flex justify-end"><button id="btn-fechar-conta" class="bg-red-600 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-md hover:bg-red-700 font-medium transition-colors text-sm sm:text-base w-full sm:w-auto"> Fechar Conta </button>
         </div>
        </div>
       </div>
      </div>
     </div><!-- Modal de Confirmação -->
     <div id="modal-confirmacao" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
      <div class="flex items-center justify-center min-h-screen p-4">
       <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="p-4 sm:p-6">
         <h3 id="modal-confirmacao-titulo" class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4">Confirmar Fechamento</h3>
         <p id="modal-confirmacao-texto" class="text-gray-600 mb-4 sm:mb-6 text-sm sm:text-base">Tem certeza que deseja fechar esta conta?</p>
         <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4"><button id="btn-cancelar-acao" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md transition-colors text-sm sm:text-base order-2 sm:order-1"> Cancelar </button> <button id="btn-confirmar-acao" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors text-sm sm:text-base order-1 sm:order-2"> Confirmar </button>
         </div>
        </div>
       </div>
      </div>
     </div>
    </main>
   </div>
   <script>
        // Configuração padrão
        const defaultConfig = {
            bar_name: "Sabor da Esquina",
            welcome_message: "Bem-vindos ao nosso bar!"
        };

        // Cardápio do bar
        const cardapio = [
            { nome: "2M Lata", preco: 60.00 },
            { nome: "2M media", preco: 60.00 },
            { nome: "Impala Lata", preco: 50.00 },
            { nome: "Impala media", preco: 50.00 },
            { nome: "Preta curta", preco: 50.00 },
            { nome: "Txilar", preco: 50.00 },
            { nome: "Castle Lite", preco: 70.00 },
            { nome: "Corona", preco: 85.00 },
            { nome: "Savana Dry", preco: 80.00 },
            { nome: "Savana Lemon", preco: 80.00 },
            { nome: "Heineken Curta", preco: 80.00 },
            { nome: "Heineken Lata", preco: 100.00 },
            { nome: "Brutal", preco: 80.00 },
            { nome: "Brutal Lata", preco: 100.00 },
            { nome: "Bernine Lata", preco: 100.00 },
            { nome: "MayFair", preco: 80.00 },
            { nome: "Água", preco: 20.00 },
            { nome: "Refresco Txoti", preco: 30.00 },
            { nome: "Capy", preco: 35.00 },
            { nome: "Água 1.5 l", preco: 40.00 },
            { nome: "Refrigerante", preco: 25.00 },
            { nome: "Água", preco: 80.00 },
            { nome: "Porção de Batata (Dose)", preco: 60.00 },
            { nome: "Porção de Batata Rachel", preco: 80.00 },
            { nome: "Sandes Simple", preco: 70.00 },
            { nome: "Sandes Rachel", preco: 85.00 },
            { nome: "Hambúrguer Simple", preco: 100.00 },
            { nome: "Hambúrguer Completo", preco: 130.00 },
            { nome: "Hambúrguer completo com batatas", preco: 150.00 },
            { nome: "Hambúrguer completo com batatas", preco: 170.00 },
            { nome: "Hambúrguer Duplo", preco: 170.00 },
            { nome: "Hambúrguer Duplo com batatas", preco: 200.00 },
        ];

        // Fallback in-memory Data SDK (used only when /_sdk/data_sdk.js is missing or fails to load)
        // This prevents the app from throwing during initialization so navigation and UI still work.
        if (!window.dataSdk) {
            (function(){
                let store = [];
                let handler = null;

                window.dataSdk = {
                    init: async (h) => {
                        handler = h || null;
                        // Deliver current (empty) data set to the handler
                        if (handler && typeof handler.onDataChanged === 'function') {
                            try { handler.onDataChanged(store); } catch (e) { console.error('dataSdk fallback handler error', e); }
                        }
                        return { isOk: true };
                    },
                    create: async (item) => {
                        store.push(item);
                        if (handler && typeof handler.onDataChanged === 'function') handler.onDataChanged(store);
                        return { isOk: true };
                    },
                    update: async (item) => {
                        const idx = store.findIndex(s => s.id === item.id);
                        if (idx >= 0) store[idx] = item; else store.push(item);
                        if (handler && typeof handler.onDataChanged === 'function') handler.onDataChanged(store);
                        return { isOk: true };
                    },
                    delete: async (item) => {
                        const idx = store.findIndex(s => s.id === item.id);
                        if (idx >= 0) store.splice(idx, 1);
                        if (handler && typeof handler.onDataChanged === 'function') handler.onDataChanged(store);
                        return { isOk: true };
                    }
                };
            })();
        }

        let contas = [];
        let contaAtual = null;
        let isLoading = false;

        // Elementos DOM
        const btnNovaContaNav = document.getElementById('btn-nova-conta');
        const btnContasAtivasNav = document.getElementById('btn-contas-ativas');
        const btnHistoricoNav = document.getElementById('btn-historico');
        const secaoNovaConta = document.getElementById('secao-nova-conta');
        const secaoContasAtivas = document.getElementById('secao-contas-ativas');
        const secaoHistorico = document.getElementById('secao-historico');
        const formNovaConta = document.getElementById('form-nova-conta');
        const modalPedidos = document.getElementById('modal-pedidos');
        const modalConfirmacao = document.getElementById('modal-confirmacao');

        let acaoConfirmacao = null;

        // Data Handler para o SDK
        const dataHandler = {
            onDataChanged(data) {
                contas = data;
                atualizarInterface();
            }
        };

        // Inicialização
        async function init() {
            // Inicializar Data SDK
            const initResult = await window.dataSdk.init(dataHandler);
            if (!initResult.isOk) {
                console.error("Erro ao inicializar Data SDK");
                return;
            }

            // Inicializar Element SDK
            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig,
                    onConfigChange: async (config) => {
                        document.getElementById('bar-title').textContent = config.bar_name || defaultConfig.bar_name;
                        document.getElementById('welcome-message').textContent = config.welcome_message || defaultConfig.welcome_message;
                    },
                    mapToCapabilities: (config) => ({
                        recolorables: [
                            {
                                get: () => config.primary_color || "#d97706",
                                set: (value) => {
                                    config.primary_color = value;
                                    window.elementSdk.setConfig({ primary_color: value });
                                }
                            }
                        ],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ["bar_name", config.bar_name || defaultConfig.bar_name],
                        ["welcome_message", config.welcome_message || defaultConfig.welcome_message]
                    ])
                });
            }

            configurarEventos();
            configurarSidebar();
            criarCardapio();
            mostrarSecao('nova-conta');
        }

        function configurarSidebar() {
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');

            // Toggle sidebar no mobile
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
                sidebarOverlay.classList.toggle('hidden');
            });

            // Fechar sidebar clicando no overlay
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            });

            // Fechar sidebar ao clicar em um item de navegação no mobile
            const navButtons = [btnNovaContaNav, btnContasAtivasNav, btnHistoricoNav];
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (window.innerWidth < 1024) {
                        sidebar.classList.add('-translate-x-full');
                        sidebarOverlay.classList.add('hidden');
                    }
                });
            });
        }

        function configurarEventos() {
            // Navegação
            btnNovaContaNav.addEventListener('click', () => mostrarSecao('nova-conta'));
            btnContasAtivasNav.addEventListener('click', () => mostrarSecao('contas-ativas'));
            btnHistoricoNav.addEventListener('click', () => mostrarSecao('historico'));

            // Formulário nova conta
            formNovaConta.addEventListener('submit', abrirNovaConta);

            // Botão limpar histórico
            document.getElementById('btn-limpar-historico').addEventListener('click', () => {
                mostrarConfirmacao('limpar', 'Limpar Histórico', 'Tem certeza que deseja excluir todo o histórico de contas? Esta ação não pode ser desfeita.');
            });

            // Modal
            document.getElementById('btn-fechar-modal').addEventListener('click', fecharModal);
            document.getElementById('btn-fechar-conta').addEventListener('click', () => {
                mostrarConfirmacao('fechar', 'Confirmar Fechamento', 'Tem certeza que deseja fechar esta conta?');
            });
            document.getElementById('btn-cancelar-acao').addEventListener('click', fecharConfirmacao);
            document.getElementById('btn-confirmar-acao').addEventListener('click', confirmarAcao);

            // Fechar modal clicando fora
            modalPedidos.addEventListener('click', (e) => {
                if (e.target === modalPedidos) fecharModal();
            });
            modalConfirmacao.addEventListener('click', (e) => {
                if (e.target === modalConfirmacao) fecharConfirmacao();
            });
        }

        function mostrarSecao(secao) {
            // Atualizar botões de navegação
            document.querySelectorAll('[id^="btn-"]').forEach(btn => {
                btn.classList.remove('bg-yellow-500', 'text-black');
                btn.classList.add('text-yellow-400');
            });

            // Ocultar todas as seções
            secaoNovaConta.classList.add('hidden');
            secaoContasAtivas.classList.add('hidden');
            secaoHistorico.classList.add('hidden');

            // Mostrar seção selecionada e atualizar botão
            switch(secao) {
                case 'nova-conta':
                    secaoNovaConta.classList.remove('hidden');
                    btnNovaContaNav.classList.add('bg-yellow-500', 'text-black');
                    btnNovaContaNav.classList.remove('text-yellow-400');
                    break;
                case 'contas-ativas':
                    secaoContasAtivas.classList.remove('hidden');
                    btnContasAtivasNav.classList.add('bg-yellow-500', 'text-black');
                    btnContasAtivasNav.classList.remove('text-yellow-400');
                    break;
                case 'historico':
                    secaoHistorico.classList.remove('hidden');
                    btnHistoricoNav.classList.add('bg-yellow-500', 'text-black');
                    btnHistoricoNav.classList.remove('text-yellow-400');
                    break;
            }
        }

        async function abrirNovaConta(e) {
            e.preventDefault();
            
            if (isLoading) return;
            
            if (contas.length >= 999) {
                mostrarMensagem("Limite máximo de 999 contas atingido. Feche algumas contas primeiro.", "error");
                return;
            }

            const nomeCliente = document.getElementById('cliente-nome').value.trim();
            const mesa = document.getElementById('mesa-numero').value.trim();

            if (!nomeCliente || !mesa) return;

            setLoading(true);

            const novaConta = {
                id: Date.now().toString(),
                cliente_nome: nomeCliente,
                mesa: mesa,
                status: "ativa",
                total: 0,
                data_abertura: new Date().toISOString(),
                data_fechamento: "",
                pedidos: JSON.stringify([])
            };

            const result = await window.dataSdk.create(novaConta);
            
            if (result.isOk) {
                formNovaConta.reset();
                mostrarMensagem("Conta aberta com sucesso!", "success");
                mostrarSecao('contas-ativas');
            } else {
                mostrarMensagem("Erro ao abrir conta. Tente novamente.", "error");
            }

            setLoading(false);
        }

        function criarCardapio() {
            const cardapioContainer = document.getElementById('cardapio');
            cardapioContainer.innerHTML = '';

            cardapio.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'bg-gray-50 p-4 rounded-lg border hover:bg-gray-100 transition-colors';
                itemDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h5 class="font-medium text-gray-800 text-sm sm:text-base">${item.nome}</h5>
                        <span class="text-amber-600 font-bold text-sm sm:text-base">MT ${item.preco.toFixed(2)}</span>
                    </div>
                    <button onclick="adicionarPedido('${item.nome}', ${item.preco})" 
                            class="w-full bg-yellow-500 text-black py-2 px-3 sm:px-4 rounded-md hover:bg-yellow-600 transition-colors text-xs sm:text-sm">
                        Adicionar
                    </button>
                `;
                cardapioContainer.appendChild(itemDiv);
            });
        }

        async function adicionarPedido(nome, preco) {
            if (!contaAtual || isLoading) return;

            setLoading(true);

            const pedidosAtuais = JSON.parse(contaAtual.pedidos || '[]');
            const novoPedido = {
                id: Date.now().toString(),
                nome: nome,
                preco: preco,
                horario: new Date().toLocaleTimeString('pt-BR')
            };

            pedidosAtuais.push(novoPedido);
            const novoTotal = pedidosAtuais.reduce((sum, pedido) => sum + pedido.preco, 0);

            const contaAtualizada = {
                ...contaAtual,
                pedidos: JSON.stringify(pedidosAtuais),
                total: novoTotal
            };

            const result = await window.dataSdk.update(contaAtualizada);
            
            if (!result.isOk) {
                mostrarMensagem("Erro ao adicionar pedido. Tente novamente.", "error");
            }

            setLoading(false);
        }

        function abrirModalPedidos(conta) {
            contaAtual = conta;
            document.getElementById('modal-titulo').textContent = `${conta.cliente_nome} - Mesa ${conta.mesa}`;
            atualizarPedidosConta();
            modalPedidos.classList.remove('hidden');
        }

        function atualizarPedidosConta() {
            if (!contaAtual) return;

            const pedidos = JSON.parse(contaAtual.pedidos || '[]');
            const container = document.getElementById('pedidos-conta');
            
            if (pedidos.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum pedido ainda</p>';
            } else {
                container.innerHTML = pedidos.map(pedido => `
                    <div class="flex justify-between items-center py-2 border-b border-gray-200 last:border-b-0">
                        <div class="flex-1 min-w-0">
                            <span class="font-medium text-sm sm:text-base block">${pedido.nome}</span>
                            <span class="text-xs sm:text-sm text-gray-500">${pedido.horario}</span>
                        </div>
                        <span class="font-bold text-amber-600 text-sm sm:text-base ml-2">MT ${pedido.preco.toFixed(2)}</span>
                    </div>
                `).join('');
            }

            document.getElementById('total-conta').textContent = contaAtual.total.toFixed(2);
        }

        function mostrarConfirmacao(acao, titulo, texto) {
            acaoConfirmacao = acao;
            document.getElementById('modal-confirmacao-titulo').textContent = titulo;
            document.getElementById('modal-confirmacao-texto').textContent = texto;
            modalConfirmacao.classList.remove('hidden');
        }

        function fecharConfirmacao() {
            modalConfirmacao.classList.add('hidden');
            acaoConfirmacao = null;
        }

        async function confirmarAcao() {
            if (!acaoConfirmacao || isLoading) return;

            setLoading(true);

            if (acaoConfirmacao === 'fechar') {
                await confirmarFechamento();
            } else if (acaoConfirmacao === 'limpar') {
                await limparHistorico();
            }

            setLoading(false);
        }

        async function confirmarFechamento() {
            if (!contaAtual) return;

            const contaFechada = {
                ...contaAtual,
                status: "fechada",
                data_fechamento: new Date().toISOString()
            };

            const result = await window.dataSdk.update(contaFechada);
            
            if (result.isOk) {
                mostrarMensagem("Conta fechada com sucesso!", "success");
                fecharModal();
                fecharConfirmacao();
                mostrarSecao('historico');
            } else {
                mostrarMensagem("Erro ao fechar conta. Tente novamente.", "error");
            }
        }

        async function limparHistorico() {
            const contasFechadas = contas.filter(conta => conta.status === 'fechada');
            
            let sucessos = 0;
            let erros = 0;

            for (const conta of contasFechadas) {
                const result = await window.dataSdk.delete(conta);
                if (result.isOk) {
                    sucessos++;
                } else {
                    erros++;
                }
            }

            fecharConfirmacao();

            if (erros === 0) {
                mostrarMensagem(`Histórico limpo com sucesso! ${sucessos} contas removidas.`, "success");
            } else {
                mostrarMensagem(`Histórico parcialmente limpo. ${sucessos} contas removidas, ${erros} erros.`, "error");
            }
        }

        function fecharModal() {
            modalPedidos.classList.add('hidden');
            contaAtual = null;
        }

        function atualizarInterface() {
            atualizarContasAtivas();
            atualizarHistorico();
            if (contaAtual) {
                // Atualizar conta atual se o modal estiver aberto
                const contaAtualizadaData = contas.find(c => c.id === contaAtual.id);
                if (contaAtualizadaData) {
                    contaAtual = contaAtualizadaData;
                    atualizarPedidosConta();
                }
            }
        }

        function atualizarContasAtivas() {
            const container = document.getElementById('lista-contas-ativas');
            const contasAtivas = contas.filter(conta => conta.status === 'ativa');

            if (contasAtivas.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma conta ativa no momento</p>';
                return;
            }

            container.innerHTML = contasAtivas.map(conta => `
                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-3 sm:space-y-0">
                        <div class="flex-1">
                            <h3 class="font-semibold text-base sm:text-lg text-gray-800">${conta.cliente_nome}</h3>
                            <p class="text-gray-600 text-sm sm:text-base">Mesa ${conta.mesa}</p>
                            <p class="text-xs sm:text-sm text-gray-500">Aberta em: ${new Date(conta.data_abertura).toLocaleString('pt-BR')}</p>
                        </div>
                        <div class="flex flex-row sm:flex-col sm:text-right items-center sm:items-end justify-between sm:justify-start">
                            <p class="text-xl sm:text-2xl font-bold text-black">MT ${conta.total.toFixed(2)}</p>
                            <button onclick="abrirModalPedidos(${JSON.stringify(conta).replace(/"/g, '&quot;')})" 
                                    class="bg-yellow-500 text-black px-3 sm:px-4 py-2 rounded-md hover:bg-yellow-600 transition-colors text-sm sm:text-base sm:mt-2">
                                Ver Conta
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function atualizarHistorico() {
            const container = document.getElementById('lista-historico');
            const contasFechadas = contas.filter(conta => conta.status === 'fechada')
                                         .sort((a, b) => new Date(b.data_fechamento) - new Date(a.data_fechamento));

            if (contasFechadas.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma conta no histórico</p>';
                return;
            }

            container.innerHTML = contasFechadas.map(conta => {
                const pedidos = JSON.parse(conta.pedidos || '[]');
                return `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-4 space-y-2 sm:space-y-0">
                            <div class="flex-1">
                                <h3 class="font-semibold text-base sm:text-lg text-gray-800">${conta.cliente_nome}</h3>
                                <p class="text-gray-600 text-sm sm:text-base">Mesa ${conta.mesa}</p>
                                <p class="text-xs sm:text-sm text-gray-500">Fechada em: ${new Date(conta.data_fechamento).toLocaleString('pt-BR')}</p>
                            </div>
                            <div class="text-left sm:text-right">
                                <p class="text-xl sm:text-2xl font-bold text-green-600">MT ${conta.total.toFixed(2)}</p>
                            </div>
                        </div>
                        ${pedidos.length > 0 ? `
                            <div class="bg-gray-50 rounded-lg p-3">
                                <h4 class="font-medium text-gray-700 mb-2 text-sm sm:text-base">Pedidos:</h4>
                                ${pedidos.map(pedido => `
                                    <div class="flex justify-between text-xs sm:text-sm py-1">
                                        <span>${pedido.nome}</span>
                                        <span>MT ${pedido.preco.toFixed(2)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function setLoading(loading) {
            isLoading = loading;
            const elements = document.querySelectorAll('button, input');
            elements.forEach(el => {
                if (loading) {
                    el.classList.add('loading');
                } else {
                    el.classList.remove('loading');
                }
            });
        }

        function mostrarMensagem(texto, tipo) {
            const mensagem = document.createElement('div');
            mensagem.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-medium z-50 ${
                tipo === 'success' ? 'bg-green-600' : 'bg-red-600'
            }`;
            mensagem.textContent = texto;
            
            document.body.appendChild(mensagem);
            
            setTimeout(() => {
                mensagem.remove();
            }, 3000);
        }

        // Inicializar quando a página carregar
        document.addEventListener('DOMContentLoaded', init);

  // Fallback in-memory Data SDK (agora com armazenamento no navegador)
if (!window.dataSdk) {
    (function(){
        let store = JSON.parse(localStorage.getItem("contasBar")) || [];
        let handler = null;

        function salvar() {
            localStorage.setItem("contasBar", JSON.stringify(store));
        }

        window.dataSdk = {
            init: async (h) => {
                handler = h || null;

                // Enviar dados armazenados para a interface
                if (handler && typeof handler.onDataChanged === 'function') {
                    try { handler.onDataChanged(store); } catch (e) {}
                }
                return { isOk: true };
            },
            create: async (item) => {
                store.push(item);
                salvar();
                if (handler?.onDataChanged) handler.onDataChanged(store);
                return { isOk: true };
            },
            update: async (item) => {
                const idx = store.findIndex(s => s.id === item.id);
                if (idx >= 0) store[idx] = item;
                else store.push(item);
                salvar();
                if (handler?.onDataChanged) handler.onDataChanged(store);
                return { isOk: true };
            },
            delete: async (item) => {
                const idx = store.findIndex(s => s.id === item.id);
                if (idx >= 0) store.splice(idx, 1);
                salvar();
                if (handler?.onDataChanged) handler.onDataChanged(store);
                return { isOk: true };
            }
        };
    })();
}


    </script>
  </div>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99f9bc6677257394',t:'MTc2MzMyNDkxOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>

</html>

